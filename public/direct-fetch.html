<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="credentialless">
  <title>MagicAI 3D Model Viewer</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
    }
    .status-bar {
      padding: 10px;
      background-color: #16213e;
      color: white;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .status-message {
      flex: 1;
      text-align: center;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .viewer-container {
      flex: 1;
      position: relative;
    }
    model-viewer {
      width: 100%;
      height: 100%;
      background-color: #0e1524;
    }
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    .error {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.8);
      color: #f43f5e;
      z-index: 10;
      text-align: center;
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #06b6d4;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .btn {
      background-color: #06b6d4;
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn:hover {
      background-color: #0891b2;
    }
    .btn:disabled {
      background-color: #475569;
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 0.7rem;
    }
  </style>
  <!-- Model viewer script with specific version to avoid CORS issues -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js" crossorigin="anonymous"></script>
  <!-- Load our enhanced model fetcher -->
  <script src="/model-fetcher.js"></script>
</head>
<body>
  <div class="container">
    <div class="status-bar">
      <div class="status-message" id="status">Initializing viewer...</div>
      <div class="action-buttons">
        <button id="downloadBtn" class="btn btn-small" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download GLB
        </button>
      </div>
    </div>
    
    <div class="viewer-container">
      <model-viewer 
        id="viewer"
        camera-controls 
        auto-rotate
        shadow-intensity="1"
        shadow-softness="0.5"
        exposure="0.8"
        ar
        ar-modes="webxr scene-viewer"
        orientation="0 0 0"
        environment-image="neutral"
        style="display:none"
      ></model-viewer>
      
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div id="loadingText">Preparing to load model...</div>
      </div>
      
      <div id="error" class="error hidden">
        <h2>Error Loading Model</h2>
        <p id="errorMessage">Failed to load 3D model.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" id="tryAgainBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            Try Again
          </button>
          <button class="btn" id="tryProxyBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
            Try Server Proxy
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get elements
      const viewer = document.getElementById('viewer');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const status = document.getElementById('status');
      const loadingText = document.getElementById('loadingText');
      const errorMessage = document.getElementById('errorMessage');
      const tryAgainBtn = document.getElementById('tryAgainBtn');
      const tryProxyBtn = document.getElementById('tryProxyBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      
      // Get model URL from query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const modelUrl = urlParams.get('url');
      
      if (!modelUrl) {
        showError('No model URL provided. Add ?url=... to the URL.');
        updateStatus('Missing model URL');
        return;
      }
      
      // Show loading state
      function showLoading(message) {
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        loadingText.textContent = message;
      }
      
      // Show error state
      function showError(message) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        errorMessage.textContent = message;
      }
      
      // Update status
      function updateStatus(message) {
        status.textContent = message;
      }
      
      // Main function to load the model
      async function loadModel(useProxy = false) {
        try {
          // Clear any previous error state
          error.classList.add('hidden');
          loading.classList.remove('hidden');
          
          // Disable viewer if it's currently visible
          viewer.style.display = 'none';
          
          // Update status
          showLoading(useProxy ? 'Loading through server proxy...' : 'Downloading model...');
          updateStatus(useProxy ? 'Using server proxy' : 'Fetching model data');
          
          // Fetch the model
          let response;
          if (useProxy) {
            // Direct proxy approach
            const proxyUrl = `/api/proxy-model?url=${encodeURIComponent(modelUrl)}`;
            response = await fetch(proxyUrl);
          } else {
            // Use our enhanced model fetcher
            response = await window.fetchModel(modelUrl);
          }
          
          if (!response.ok && useProxy) {
            // For proxy requests we know ok status
            throw new Error(`Failed to fetch model: ${response.status} ${response.statusText}`);
          }
          
          // For non-proxy, since XHR or no-cors might be used, we can't check response.ok
          
          // Get the blob data
          updateStatus('Processing model data');
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          
          // Setup download functionality
          downloadBtn.onclick = function() {
            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = modelUrl.split('/').pop() || 'model.glb';
            a.click();
          };
          downloadBtn.disabled = false;
          
          // Load the model into the viewer
          updateStatus('Loading model into viewer');
          viewer.setAttribute('src', objectUrl);
          viewer.style.display = 'block';
          
          // Handle model load success
          viewer.addEventListener('load', function onLoad() {
            loading.classList.add('hidden');
            updateStatus('Model loaded successfully');
            viewer.removeEventListener('load', onLoad);
          });
          
          // Handle model load error
          viewer.addEventListener('error', function onError(e) {
            console.error('Model viewer error:', e);
            showError('Error displaying the model. Try downloading instead.');
            updateStatus('Error displaying model');
            viewer.removeEventListener('error', onError);
          });
        } catch (error) {
          console.error('Error loading model:', error);
          showError(`Failed to load model: ${error.message}`);
          updateStatus('Error loading model');
        }
      }
      
      // Event listeners
      tryAgainBtn.addEventListener('click', function() {
        loadModel(false);
      });
      
      tryProxyBtn.addEventListener('click', function() {
        loadModel(true);
      });
      
      // Start loading the model
      loadModel(false);
    });
  </script>
</body>
</html>